machine:
  pre:
    # - sudo apt-get update; USE_PRECOMPILE=true sudo -E circleci-install php 7.1.3
    # - curl -sL https://deb.nodesource.com/setup_7.x | sudo -E bash - sudo apt-get install -y nodejs
  php:
    version: 7.1.3
  node:
    version: 6.9.5
  npm:
    version: 3.10.10
  services:
    - redis
  environment:
    APP_ENV: testing
    APP_KEY: base64:LF59HSl+nzkPzGVmLHvz87N/Mwc6vgEOCxlLdChfMKs=
    DB_DATABASE: circle_test
    DB_USERNAME: ubuntu
    CACHE_DRIVER: redis
    SESSION_DRIVER: redis
    SKIP_LONG_TESTS: true

general:
  # artifacts:
  #   - "reports"

dependencies:
  pre:
    - echo "memory_limit = 512M" > $PHPENV_ROOT/versions/$(phpenv global)/etc/conf.d/memory.ini
    # - sed -i 's/^;//' ~/.phpenv/versions/$(phpenv global)/etc/conf.d/xdebug.ini
  override:
    # Checks all php files within /app for syntax errors
    # - tests/commands/phplint.sh
    - composer install --prefer-dist --no-interaction

    # - npm install cross-env
    # - npm install -g npm
    # - npm update
    - npm install
    - npm run production
    # Run the CS fixer and error if it finds files to update
    # - tests/commands/php-cs-fixer-check.sh
    - wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
    - sudo sh -c 'echo "deb http://dl.google.com/linux/chrome/deb stable main" >> /etc/apt/sources.list.d/google.list'
    - sudo apt-get update
    - sudo apt-get install google-chrome-stable
  cache_directories:
    # - "~/.composer/cache"
    # - "reports/phplint/.cache"
    # - "vendor"

database:
  override:
    - php artisan migrate:refresh --force --env=testing -vvv
    - php artisan db:seed -vvv

test:
  # pre:
  #   # - wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
  #   # - sudo sh -c 'echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb stable main" >> /etc/apt/sources.list.d/google.list'
  #   # - sudo apt-get update
  #   # - sudo apt-get --only-upgrade install google-chrome-stable
  #   - "./vendor/laravel/dusk/bin/chromedriver-linux":
  #       background: true
  #   - cp .env.testing .env
  #   - "php artisan serve":
  #       background: true
  override:
   # - php artisan dusk
   - vendor/bin/phpunit